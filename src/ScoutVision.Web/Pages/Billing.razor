@page "/billing"
@using System.Net.Http.Json
@inject HttpClient Http
@using MudBlazor

<PageTitle>ScoutVision Billing</PageTitle>

<MudPaper Class="pa-6" Elevation="2">
    <MudText Typo="Typo.h4" Class="mb-4">Generate Invoice</MudText>
    <MudForm @ref="_form">
        <MudTextField @bind-Value="OrgId" Label="Organization ID" Required="true" />
        <MudNumericField @bind-Value="UserCount" Label="User Count" Min="1" Max="1000" Required="true" />
        <MudSwitch @bind-Value="IsAnnual" Color="Color.Primary" Label="Annual Billing" />
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="GenerateInvoice">Generate Invoice</MudButton>
    </MudForm>
    @if (Invoice != null)
    {
        <MudDivider Class="my-4" />
        <MudText Typo="Typo.h6">Invoice Details</MudText>
        <MudSimpleTable>
            <thead>
                <tr>
                    <th>Organization</th>
                    <th>User Count</th>
                    <th>Annual</th>
                    <th>Amount Due</th>
                    <th>Invoice Date</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@Invoice.OrganizationId</td>
                    <td>@Invoice.UserCount</td>
                    <td>@Invoice.IsAnnual</td>
                    <td>@Invoice.AmountDue.ToString("C")</td>
                    <td>@Invoice.InvoiceDate.ToShortDateString()</td>
                    <td>@Invoice.DueDate.ToShortDateString()</td>
                </tr>
            </tbody>
        </MudSimpleTable>
    }
</MudPaper>

@code {
    private MudForm? _form;
    public string OrgId { get; set; } = string.Empty;
    public int UserCount { get; set; } = 1;
    public bool IsAnnual { get; set; } = false;
    public InvoiceModel? Invoice { get; set; }

    public class InvoiceModel
    {
        public string OrganizationId { get; set; } = string.Empty;
        public int UserCount { get; set; }
        public bool IsAnnual { get; set; }
        public decimal AmountDue { get; set; }
        public DateTime InvoiceDate { get; set; }
        public DateTime DueDate { get; set; }
    }

    private async Task GenerateInvoice()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_form.IsValid) return;
        }
        else return;
        var response = await Http.PostAsync($"/api/billing/generate-invoice?orgId={OrgId}&userCount={UserCount}&annual={IsAnnual}", null);
        Invoice = await response.Content.ReadFromJsonAsync<InvoiceModel>();
        StateHasChanged();
    }
}
